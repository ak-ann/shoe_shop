<!-- templates/admin/products.html -->
{% extends "admin/base.html" %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Заголовок с хлебными крошками -->
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <div>
            <h1 class="h3 mb-1 fw-bold" style="color: #222222;">Управление товарами</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0" style="background-color: #FAFAFA; padding: 0.5rem 0.75rem; border-radius: 4px;">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('admin.dashboard') }}" style="color: #800020; text-decoration: none;">
                            <i class="fas fa-home me-1"></i>Главная
                        </a>
                    </li>
                    <li class="breadcrumb-item active" style="color: #222222;">Товары</li>
                </ol>
            </nav>
        </div>
        <a href="{{ url_for('admin.create_product') }}" class="btn fw-medium" 
           style="background-color: #800020; color: white; border: none; padding: 0.5rem 1.5rem;">
            <i class="fas fa-plus me-2"></i>Добавить товар
        </a>
    </div>

    <!-- Фильтры -->
    <div class="card mb-4 border-0 shadow-sm" style="background-color: #FAFAFA;">
        <div class="card-body p-3">
            <form method="GET" action="{{ url_for('admin.products') }}" class="row g-2">
                <div class="col-md-3">
                    <select class="form-select form-select-sm border-0" name="category_id" onchange="this.form.submit()" 
                            style="background-color: white; color: #222222;">
                        <option value="">Все категории</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm border-0" name="brand_id" onchange="this.form.submit()" 
                            style="background-color: white; color: #222222;">
                        <option value="">Все бренды</option>
                        {% for brand in brands %}
                        <option value="{{ brand.id }}" {% if selected_brand == brand.id %}selected{% endif %}>
                            {{ brand.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm border-0" name="status" onchange="this.form.submit()" 
                            style="background-color: white; color: #222222;">
                        <option value="">Все статусы</option>
                        <option value="published" {% if selected_status == 'published' %}selected{% endif %}>Опубликовано</option>
                        <option value="draft" {% if selected_status == 'draft' %}selected{% endif %}>Черновик</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control border-0" name="search" 
                               placeholder="Поиск по названию, артикулу..." 
                               value="{{ search_query }}" 
                               style="background-color: white; color: #222222;">
                        <button class="btn" type="submit" 
                                style="background-color: #800020; color: white; border: none;">
                            <i class="fas fa-search"></i>
                        </button>
                        {% if selected_category or selected_brand or selected_status or search_query %}
                        <a href="{{ url_for('admin.products') }}" class="btn" 
                           style="background-color: #660033; color: white; border: none;">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </form>
            
            {% if selected_category or selected_brand or selected_status or search_query %}
            <div class="mt-2">
                <small style="color: #666666;">
                    Активные фильтры: 
                    {% if selected_category %}Категория • {% endif %}
                    {% if selected_brand %}Бренд • {% endif %}
                    {% if selected_status %}Статус • {% endif %}
                    {% if search_query %}Поиск • {% endif %}
                    <a href="{{ url_for('admin.products') }}" style="color: #800020; text-decoration: none;">
                        Сбросить всё
                    </a>
                </small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Таблица товаров -->
    <div class="card border-0 shadow-sm">
        <div class="card-header py-3 border-0" style="background-color: #800020; color: white;">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-list me-2"></i>Список товаров
                </h5>
                <div class="small">
                    <span class="fw-bold">{{ products|length }}</span> товаров
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if products %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr style="background-color: #FAFAFA; color: #222222;">
                            <th class="ps-4 py-3" style="font-weight: 600;">ID</th>
                            <th class="py-3" style="font-weight: 600;">Товар</th>
                            <th class="py-3" style="font-weight: 600;">Категория</th>
                            <th class="py-3" style="font-weight: 600;">Бренд</th>
                            <th class="py-3 text-center" style="font-weight: 600;">Цена</th>
                            <th class="py-3 text-center" style="font-weight: 600;">Остаток</th>
                            <th class="py-3 text-center" style="font-weight: 600;">Статус</th>
                            <th class="py-3 text-end pe-4" style="font-weight: 600;">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td class="ps-4 align-middle">
                                <span style="color: #666666; font-size: 0.9rem;">#{{ product.id }}</span>
                            </td>
                            <td class="align-middle">
                                <div class="d-flex align-items-center">
                                    {% if product.image_url %}
                                    <div class="me-3">
                                        <div style="width: 50px; height: 50px; overflow: hidden; border-radius: 6px; border: 1px solid #eee;">
                                            <img src="{{ product.image_url }}" alt="{{ product.name }}" 
                                                 style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="fw-medium" style="color: #222222; margin-bottom: 2px;">
                                            {{ product.name|truncate(35) }}
                                        </div>
                                        <div style="color: #666666; font-size: 0.85rem;">
                                            {{ product.sku if product.sku else 'Без артикула' }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="align-middle">
                                {% if product.category_name and product.category_name != 'Без категории' %}
                                <span class="badge" 
                                      style="background-color: rgba(128, 0, 32, 0.1); color: #800020; border: none; font-weight: 500;">
                                    {{ product.category_name|truncate(15) }}
                                </span>
                                {% else %}
                                <span style="color: #999999;">—</span>
                                {% endif %}
                            </td>
                            <td class="align-middle">
                                {% if product.brand_name and product.brand_name != 'Без бренда' %}
                                <span class="badge" 
                                      style="background-color: rgba(102, 0, 51, 0.1); color: #660033; border: none; font-weight: 500;">
                                    {{ product.brand_name|truncate(15) }}
                                </span>
                                {% else %}
                                <span style="color: #999999;">—</span>
                                {% endif %}
                            </td>
                            <td class="align-middle text-center fw-bold" style="color: #222222;">
                                {{ product.price|int }} ₽
                            </td>
                            <td class="align-middle text-center">
                                {% if product.stock_quantity is not none %}
                                <span class="badge {% if product.stock_quantity > 10 %}bg-success{% elif product.stock_quantity > 0 %}bg-warning{% else %}bg-danger{% endif %}" 
                                      style="font-weight: 500; border: none;">
                                    {{ product.stock_quantity }} шт.
                                </span>
                                {% else %}
                                <span style="color: #999999;">—</span>
                                {% endif %}
                            </td>
                            <td class="align-middle text-center">
                                {% if product.is_published %}
                                <span class="badge" 
                                      style="background-color: rgba(40, 167, 69, 0.1); color: #28a745; font-weight: 500; border: none;">
                                    <i class="fas fa-check-circle me-1"></i>Активен
                                </span>
                                {% else %}
                                <span class="badge" 
                                      style="background-color: rgba(108, 117, 125, 0.1); color: #6c757d; font-weight: 500; border: none;">
                                    <i class="fas fa-eye-slash me-1"></i>Скрыт
                                </span>
                                {% endif %}
                            </td>
                            <td class="align-middle text-end pe-4">
                                <div class="btn-group">
                                    <a href="{{ url_for('admin.edit_product', id=product.id) }}" 
                                       class="btn btn-sm" 
                                       style="background-color: #800020; color: white; border: none; border-radius: 4px 0 0 4px;">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" 
                                            class="btn btn-sm btn-danger" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#deleteModal{{ product.id }}"
                                            style="border-radius: 0 4px 4px 0;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                
                                <!-- Модальное окно удаления -->
                                <div class="modal fade" id="deleteModal{{ product.id }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header border-0">
                                                <h5 class="modal-title fw-bold" style="color: #222222;">Удалить товар?</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="text-center mb-3">
                                                    <div class="mb-3" style="color: #800020; font-size: 2rem;">
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                    </div>
                                                    <h6 class="fw-bold" style="color: #222222;">{{ product.name }}</h6>
                                                    <p class="text-muted small">
                                                        ID: {{ product.id }} • Арт: {{ product.sku if product.sku else '—' }}
                                                    </p>
                                                </div>
                                                <p style="color: #666666;">
                                                    Вы уверены, что хотите удалить этот товар? Это действие нельзя отменить.
                                                </p>
                                            </div>
                                            <div class="modal-footer border-0">
                                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                                                <form action="{{ url_for('admin.delete_product', id=product.id) }}" method="POST">
                                                    <button type="submit" class="btn" 
                                                            style="background-color: #800020; color: white; border: none;">
                                                        Удалить
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <!-- Пустое состояние -->
            <div class="text-center py-5" style="background-color: #FAFAFA;">
                <div class="mb-4" style="color: #800020; font-size: 3rem;">
                    <i class="fas fa-box-open"></i>
                </div>
                {% if selected_category or selected_brand or selected_status or search_query %}
                <h5 class="fw-bold mb-2" style="color: #222222;">Товары не найдены</h5>
                <p class="mb-3" style="color: #666666;">
                    По вашему запросу ничего не найдено. Попробуйте изменить параметры фильтрации.
                </p>
                <a href="{{ url_for('admin.products') }}" class="btn btn-sm" 
                   style="background-color: #800020; color: white; border: none;">
                    <i class="fas fa-times me-1"></i>Сбросить фильтры
                </a>
                {% else %}
                <h5 class="fw-bold mb-2" style="color: #222222;">Товаров пока нет</h5>
                <p class="mb-3" style="color: #666666;">
                    Добавьте первый товар, чтобы начать продавать в вашем магазине.
                </p>
                <a href="{{ url_for('admin.create_product') }}" class="btn" 
                   style="background-color: #800020; color: white; border: none; padding: 0.5rem 1.5rem;">
                    <i class="fas fa-plus me-2"></i>Добавить товар
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        {% if products and products|length > 10 %}
        <div class="card-footer py-2 border-0" style="background-color: #FAFAFA;">
            <div class="d-flex justify-content-between align-items-center">
                <div style="color: #666666; font-size: 0.9rem;">
                    Показано {{ products|length }} товаров
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Авто-отправка поиска с задержкой
    let searchTimer;
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                this.form.submit();
            }, 500);
        });
    }
});
</script>

<style>
.table-hover tbody tr:hover {
    background-color: rgba(128, 0, 32, 0.03) !important;
}

/* Кастомные скругления для кнопок */
.btn-group .btn:first-child {
    border-radius: 4px 0 0 4px !important;
}

.btn-group .btn:last-child {
    border-radius: 0 4px 4px 0 !important;
}

/* Убираем стандартные стили Bootstrap */
.badge {
    padding: 0.35em 0.65em;
    font-size: 0.85em;
}

.form-select:focus, .form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(128, 0, 32, 0.25) !important;
    border-color: #800020 !important;
}
</style>
{% endblock %}