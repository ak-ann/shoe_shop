<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ | Luxury Shoes</title>
    <style>
        /* –í–∞—à–∞ —Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
        :root {
            --primary-bg: #FFFFFF;
            --secondary-bg: #FAFAFA;
            --text-primary: #222222;
            --accent-primary: #800020;
            --accent-secondary: #660033;
            --accent-dark: #900020;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-primary);
            text-decoration: none;
        }
        
        .checkout-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 50px;
        }
        
        .checkout-form {
            background: var(--primary-bg);
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #eee;
        }
        
        .checkout-summary {
            background: var(--secondary-bg);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #eee;
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--accent-primary);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-secondary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.1);
        }
        
        .required::after {
            content: " *";
            color: var(--accent-primary);
        }
        
        .order-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .item-price {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 18px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .summary-row.total {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent-primary);
            border-bottom: 2px solid var(--accent-secondary);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .payment-method {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .payment-method:hover {
            border-color: var(--accent-primary);
        }
        
        .payment-method.active {
            border-color: var(--accent-primary);
            background-color: rgba(128, 0, 32, 0.05);
        }
        
        .payment-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .btn-primary {
            background-color: var(--accent-primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary:hover {
            background-color: var(--accent-dark);
        }
        
        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .footer {
            text-align: center;
            padding: 30px 0;
            border-top: 1px solid #eee;
            margin-top: 50px;
            color: #666;
            background: var(--secondary-bg);
        }
        
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="/" class="logo">LUXURY SHOES</a>
            <div>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
        </header>
        
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="alertSuccess" class="alert alert-success" style="display: none;"></div>
        <div id="alertError" class="alert alert-error" style="display: none;"></div>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>–û—Ñ–æ—Ä–º–ª—è–µ–º –≤–∞—à –∑–∞–∫–∞–∑...</p>
        </div>
        
        <div class="checkout-container">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
            <div class="checkout-form">
                <form id="checkoutForm">
                    <div class="form-section">
                        <h2 class="section-title">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                        <div class="form-group">
                            <label for="fullName" class="required">–ü–æ–ª–Ω–æ–µ –∏–º—è</label>
                            <input type="text" id="fullName" name="fullName" required 
                                placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                                value="{% if current_user.is_authenticated %}{% if current_user.first_name or current_user.last_name %}{{ current_user.first_name or '' }} {{ current_user.last_name or '' }}{% else %}{{ current_user.username or '' }}{% endif %}{% endif %}" 
                                autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label for="email" class="required">Email</label>
                            <input type="email" id="email" name="email" required 
                                placeholder="example@mail.com"
                                value="{{ current_user.email if current_user.is_authenticated else '' }}" 
                                autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label for="phone" class="required">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input type="tel" id="phone" name="phone" required 
                                placeholder="+7 (999) 999-99-99"
                                value="{{ current_user.phone if (current_user.is_authenticated and current_user.phone) else '' }}" 
                                autocomplete="tel">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h2 class="section-title">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
                        <div class="form-group">
                            <label for="address" class="required">–ê–¥—Ä–µ—Å</label>
                            <input type="text" id="address" name="address" required 
                                placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞"
                                value="{{ current_user.address if (current_user.is_authenticated and current_user.address) else '' }}" 
                                autocomplete="street-address">
                        </div>
                        <div class="form-group">
                            <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –¥–æ—Å—Ç–∞–≤–∫–µ</label>
                            <textarea id="comment" name="comment" rows="3" 
                                    placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫—É—Ä—å–µ—Ä–∞ (–Ω–æ–º–µ—Ä –ø–æ–¥—ä–µ–∑–¥–∞, –∫–æ–¥ –¥–æ–º–æ—Ñ–æ–Ω–∞ –∏ —Ç.–¥.)"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h2 class="section-title">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h2>
                        <div class="payment-methods">
                            <div class="payment-method active" data-method="card">
                                <div class="payment-icon">üí≥</div>
                                <div>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</div>
                            </div>
                            <div class="payment-method" data-method="cash">
                                <div class="payment-icon">üí∞</div>
                                <div>–ù–∞–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</div>
                            </div>
                            <div class="payment-method" data-method="online">
                                <div class="payment-icon">üåê</div>
                                <div>–û–Ω–ª–∞–π–Ω –ø–µ—Ä–µ–≤–æ–¥</div>
                            </div>
                        </div>
                        <input type="hidden" id="paymentMethod" name="paymentMethod" value="card">
                    </div>
                    
                    <div class="form-section">
                        <h2 class="section-title">–°–æ–≥–ª–∞—Å–∏–µ</h2>
                        <div class="form-group">
                            <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                <input type="checkbox" id="agreeTerms" name="agreeTerms" required style="margin-right: 10px; margin-top: 3px;">
                                <span>–Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å —É—Å–ª–æ–≤–∏—è–º–∏ <a href="/terms" target="_blank">–æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a> –∏ <a href="/policy" target="_blank">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></span>
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary" id="placeOrderBtn">
                        –û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó
                    </button>
                </form>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–≤–æ–¥–∫–∞ –∑–∞–∫–∞–∑–∞ -->
            <div class="checkout-summary">
                <h2 class="section-title">–í–∞—à –∑–∞–∫–∞–∑</h2>
                
                <div class="order-items" id="orderItems">
                    <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                
                <div class="summary-details" id="summaryDetails">
                    <div class="summary-row">
                        <span>–¢–æ–≤–∞—Ä—ã (<span id="itemsCount">0</span>)</span>
                        <span id="itemsTotal">0 ‚ÇΩ</span>
                    </div>
                    <div class="summary-row">
                        <span>–î–æ—Å—Ç–∞–≤–∫–∞</span>
                        <span id="deliveryCost">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                    </div>
                    <div class="summary-row" id="discountRow" style="display: none;">
                        <span>–°–∫–∏–¥–∫–∞</span>
                        <span id="discountAmount">0 ‚ÇΩ</span>
                    </div>
                    <div class="summary-row total">
                        <span>–ò—Ç–æ–≥–æ</span>
                        <span id="totalAmount">0 ‚ÇΩ</span>
                    </div>
                </div>
                
                <p style="text-align: center; margin-top: 15px; font-size: 14px; color: #666; line-height: 1.4;">
                    –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                </p>
            </div>
        </div>
        
        <footer class="footer">
            <p>¬© {{ current_year }} Luxury Shoes. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            <a href="/cart" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–∑–∏–Ω—É</a>
        </footer>
    </div>

    <script>
    // –î–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã
    let cartItems = [];

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
    async function loadCart() {
        try {
            console.log("=== DEBUG: Loading cart for checkout page");
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ —à–∞–±–ª–æ–Ω–µ
            // –ú—ã –ø–µ—Ä–µ–¥–∞–µ–º cart_items –∏ total –∏–∑ Python –≤ —à–∞–±–ª–æ–Ω
            {% if cart_items and total %}
            console.log("=== DEBUG: Found cart data in template:", {{ cart_items|length }}, "items");
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ Python –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è JavaScript
            cartItems = [
                {% for item in cart_items %}
                {
                    cart_item_id: {{ item.cart_item_id }},
                    product_id: {{ item.product_id }},
                    name: "{{ item.product_name.replace('"', '\\"') if item.product_name else '–¢–æ–≤–∞—Ä' }}",
                    size: "{{ item.size if item.size else '' }}",
                    quantity: {{ item.quantity }},
                    price: {{ item.price }},
                    image_url: "{{ item.product_image if item.product_image else '' }}"
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            
            console.log("=== DEBUG: Cart items loaded:", cartItems);
            updateOrderSummary();
            
            {% else %}
            console.log("=== DEBUG: No cart data in template");
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            document.getElementById('orderItems').innerHTML = 
                '<p style="text-align: center; color: #666; padding: 20px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã.</p>';
            document.getElementById('placeOrderBtn').disabled = true;
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–∑–∏–Ω—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            {% endif %}
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ—Ä–∑–∏–Ω—ã:', error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ—Ä–∑–∏–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤–æ–¥–∫–∏ –∑–∞–∫–∞–∑–∞
    function updateOrderSummary() {
        const orderItemsContainer = document.getElementById('orderItems');
        const itemsCountElement = document.getElementById('itemsCount');
        const itemsTotalElement = document.getElementById('itemsTotal');
        const totalAmountElement = document.getElementById('totalAmount');
        
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        orderItemsContainer.innerHTML = '';
        
        if (cartItems.length === 0) {
            itemsCountElement.textContent = '0';
            itemsTotalElement.textContent = '0 ‚ÇΩ';
            totalAmountElement.textContent = '0 ‚ÇΩ';
            document.getElementById('placeOrderBtn').disabled = true;
            return;
        }
        
        let totalItems = 0;
        let totalPrice = 0;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã
        cartItems.forEach(item => {
            totalItems += item.quantity || 1;
            const price = item.price || 0;
            const quantity = item.quantity || 1;
            const subtotal = price * quantity;
            totalPrice += subtotal;
            
            const itemElement = document.createElement('div');
            itemElement.className = 'order-item';
            itemElement.innerHTML = `
                <div class="item-image">
                    ${item.image_url ? 
                        `<img src="${item.image_url}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` : 
                        'üëû'}
                </div>
                <div class="item-details">
                    <div class="item-name">${item.name || '–¢–æ–≤–∞—Ä'}</div>
                    <div>–†–∞–∑–º–µ—Ä: ${item.size || '-'}</div>
                    <div>–ö–æ–ª-–≤–æ: ${quantity} —à—Ç.</div>
                    <div class="item-price">${subtotal.toLocaleString('ru-RU')} ‚ÇΩ</div>
                </div>
            `;
            orderItemsContainer.appendChild(itemElement);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏
        itemsCountElement.textContent = totalItems;
        itemsTotalElement.textContent = totalPrice.toLocaleString('ru-RU') + ' ‚ÇΩ';
        totalAmountElement.textContent = totalPrice.toLocaleString('ru-RU') + ' ‚ÇΩ';
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
        document.getElementById('placeOrderBtn').disabled = false;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
    function showError(message) {
        const alert = document.getElementById('alertError');
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ
    function showSuccess(message) {
        const alert = document.getElementById('alertSuccess');
        alert.textContent = message;
        alert.style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', function() {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('paymentMethod').value = this.dataset.method;
        });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
        if (cartItems.length === 0) {
            showError('–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏
        if (!document.getElementById('agreeTerms').checked) {
            showError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
            return;
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        const requiredFields = ['fullName', 'email', 'phone', 'address'];
        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                showError(`–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "${field.previousElementSibling.textContent.replace(' *', '')}"`);
                field.focus();
                return;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ email
        const email = document.getElementById('email').value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å');
            document.getElementById('email').focus();
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        showLoading(true);
        const btn = document.getElementById('placeOrderBtn');
        const originalText = btn.textContent;
        btn.textContent = '–û–§–û–†–ú–õ–Ø–ï–ú...';
        btn.disabled = true;
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const formData = {
            fullName: document.getElementById('fullName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            comment: document.getElementById('comment').value,
            paymentMethod: document.getElementById('paymentMethod').value,
            items: cartItems.map(item => ({
                product_id: item.product_id,
                product_name: item.name,
                size: item.size,
                quantity: item.quantity,
                price: item.price
            }))
        };
        
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const response = await fetch('/api/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                showSuccess(`–ó–∞–∫–∞–∑ ‚Ññ${data.order_number} —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –°—É–º–º–∞: ${data.total_amount} ‚ÇΩ`);
                
                // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
                cartItems = [];
                updateOrderSummary();
                
                // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    window.location.href = `/order-success/${data.order_number}`;
                }, 2000);
            } else {
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + data.message);
                btn.textContent = originalText;
                btn.disabled = false;
                showLoading(false);
            }
        } catch (error) {
            console.error('Error:', error);
            showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            btn.textContent = originalText;
            btn.disabled = false;
            showLoading(false);
        }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadCart();
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ URL (–µ—Å–ª–∏ –µ—Å—Ç—å)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('fullName')) {
            document.getElementById('fullName').value = urlParams.get('fullName') || '';
            document.getElementById('email').value = urlParams.get('email') || '';
            document.getElementById('phone').value = urlParams.get('phone') || '';
            document.getElementById('address').value = urlParams.get('address') || '';
            
            const paymentMethod = urlParams.get('paymentMethod') || 'card';
            document.getElementById('paymentMethod').value = paymentMethod;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
            document.querySelectorAll('.payment-method').forEach(method => {
                if (method.dataset.method === paymentMethod) {
                    method.classList.add('active');
                } else {
                    method.classList.remove('active');
                }
            });
            
            // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const phoneInput = document.getElementById('phone');
        phoneInput.addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, '');
            if (value.startsWith('8')) {
                value = '7' + value.substring(1);
            }
            
            let formattedValue = '';
            if (value.length > 0) {
                formattedValue = '+';
                if (value.length <= 1) formattedValue += value;
                else if (value.length <= 4) formattedValue += value.substring(0, 1) + ' (' + value.substring(1);
                else if (value.length <= 7) formattedValue += value.substring(0, 1) + ' (' + value.substring(1, 4) + ') ' + value.substring(4);
                else if (value.length <= 9) formattedValue += value.substring(0, 1) + ' (' + value.substring(1, 4) + ') ' + value.substring(4, 7) + '-' + value.substring(7);
                else formattedValue += value.substring(0, 1) + ' (' + value.substring(1, 4) + ') ' + value.substring(4, 7) + '-' + value.substring(7, 9) + '-' + value.substring(9, 11);
            }
            this.value = formattedValue;
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π
        const formInputs = document.querySelectorAll('#checkoutForm input, #checkoutForm textarea');
        formInputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (this.value.trim() === '') {
                    this.style.borderColor = '#ff6b6b';
                } else {
                    this.style.borderColor = '#ddd';
                }
            });
        });
    });

    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤ –∫–æ—Ä–∑–∏–Ω—É
    document.addEventListener('DOMContentLoaded', function() {
        const backLink = document.querySelector('.back-link');
        if (backLink) {
            backLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                    window.location.href = '/cart';
                }
            });
        }
    });
    </script>
</body>
</html>